# パスモデル

## パス図
**パスモデル**（path models），**パス解析**（path analysis）を通じて，**パス図**（path diagram）の考え方を習得し，回帰分析より柔軟なモデル構成に進みましょう。

以下は，変数間の影響関係を記述するモデル式をグラフィカルに示す，パス図と呼ばれる描画手法
に用いられる記号，部品を示したものです。
![](/images/path_diagram_symbols.png){width=85%}

モデル式とパス図は一対一に対応します。AMOS（**A**nalysis of **MO**ment **S**tructures; 積率構造分析）というソフトウェアが「お絵かきソフト」のように図を描くことでSEMが実行できるのも，このため（パス図を描けばモデル式が出力可能）です。なお，その特質が手法をおおいに普及させた，という側面もあります。

よくみるパス図の慣行にしたがって，円と楕円を分けていますが，本質的には同じです。直接観測されない変数である誤差変数や潜在変数をマルで囲んで表します。多くの場合，「誤差」は円で，「能力」や「性格」など構成概念を表す潜在変数は楕円で表されますが，誤差を楕円で囲むこともありますし，円で囲まない記法もあります。

三角形で定数（回帰分析における切片）を表します。ただし，基本的なSEMでは標準化されたデータを扱うため，パス図において主に使用されるパーツは，上図の三角形を除いた5つ（円／楕円を区別しなければ4つ）です。

単方向の矢印で変数間を結び，両者の影響関係を表します。矢印を出す側が独立変数（説明変数）で，矢印を受ける側が従属変数（目的変数）です。その影響の程度，すなわち回帰分析における回帰係数を，パスモデルでは**パス係数**（path coefficients）と呼び，矢印の上に表記します。

双方向矢印は共変動の関係を表します。すなわち相関係数や共分散です。なお，単方向の矢印が２変数の間でお互いに向き合う（$X$が$Y$に影響し，$Y$が$X$に影響する）というモデルを構成することは（基本的には）できません。

## パスモデルとしての重回帰分析
3つの独立変数から1つの従属変数を説明，予測する重回帰モデル
$$y = i + ax_1+bx_2+cx_3+誤差$$
を考えましょう。図の表記の便宜上，切片を $i$ とし，$e$ として表されることの多い誤差項を $誤差$ と表すこととします。

例えば，親の収入（$x_1$）と学業成績（$x_2$）と学業上の向上心（$x_3$）が，定量的に把握できる達成度（$y$）に与える影響の分析を想定します。

パス図で表すと以下の通りです。

![](/images/ch05_multireg_const.png){width=70%}

定数である切片は，三角形で表される，常に値 $1$ をとる変数からの係数 $i$ として表されます。

誤差変数においては，相関，共分散のような連動関係を表す双方向矢印が*自分自身に*刺さっています。自分自身との共分散なので，すなわち分散（標準化していれば標準偏差）を表します。ただ，この表記は省略される場合も多く，その場合は単に，分散を表すパラメータ（この場合は$g$）のみを表示します（その意味では，独立変数の分散を表す，自分自身にループする双方向矢印はほとんどの場合に省略されている，ともいえます［ループ双方向矢印を独立変数に示す場合もある］）。

パス係数は必ずしも標準化解に統一する必要はありませんが，以降は，データを標準化し，以下の100人分のデータから計算された相関係数行列に基づいて考察することとします。

![](/images/ch05_cormat4.png){width=75%}

重回帰モデルは切片を除いて
$$y = ax_1+bx_2+cx_3+誤差$$
と表され，三角形と矢印と $i$ を除いたものが該当のパス図になります。

## 相関係数のパラメータ表示
ここで，4変数間の相関係数と，（定数項を除いた）パス図の対応を考えましょう。

相関係数行列は，４つの変数の連動関係を示しています。そこに方向はありません。

一方で，取り上げているパスモデル（重回帰モデル）においては，$a$，$b$，$c$ のパス係数（標準化偏回帰係数）と独立変数間の相関係数 $d$，$e$，$f$，誤差の分散（標準偏差） $g$ といったモデルを特徴づけるパラメータが導入され，変数 $y$（達成度）は他の3つの影響を受けて値が変化する，という考え（仮説，モデル） が示されています。

これはつまり
$$
x_1 と y \ の相関 = a + (d \times b) + (e\times c)
$$
のように再表現したということです。$x_1$ と $y$ はどのように連結（相関）しているのか，**トレーシングルール**（tracing rules）と呼ばれる考え方で，適切な $x_1$ と $y$ の経路（パス）を特定し，上式の関係を導くことができます。

## トレーシングルール

パス図において，２つの変数または１つの変数に注目し，その変数に至るパスを辿って，各パスの係数を掛け，可能なパスすべての結果を足し合わせます。ただし，

* 単方向矢印を逆向きに辿り始めることは可能ですが，順行したらもう逆行はできません。

* 一回通った変数を，もう一度通過することはできません。

* 経路には，双方向矢印を最大でも１つしか含められません。

$x_1$ と $y$ に注目しましょう。まず，ダイレクトなパスがあります。パス係数は $a$（のみ）です。次に，双方向矢印（相関 $d$）を辿って$x_2$に行き，$x_2$ から $y$ に至るパスがあります（係数 $b$ ）。したがって，$(d \times b)$ です。最後に，$(e \times c)$となります。$x_1$ から $x_3$ に行って，$y$ に至る経路です。これらを足し合わせて
$$
x_1 と y \ の相関 = a + (d \times b) + (e\times c)
$$
となります。　

$(d \times f \times c)$ もパスとしてはあるではないか，と思われるかもしれませんが（私は初見そう思った$\cdots$），これは「双方向矢印は最大でも１つしか含められない」に抵触するため採用できません。

## パス係数の値
同様（ぜひ確認してみましょう）にして，各独立変数と従属変数の相関係数について以下が得られます。
\begin{align*}
x_1 と y \ の相関 = a + (d \times b) + (e\times c)\\
x_2 と y \ の相関 = b + (d \times a) + (f\times c)\\
x_3 と y \ の相関 = c + (f \times b) + (e\times a)
\end{align*}

4変数の相関係数行列から
\begin{align*}
0.78 = a + (0.66 \times b) + (0.68 \times c)\\
0.53 = b + (0.66 \times a) + (0.60 \times c)\\
0.50 = c + (0.60 \times b) + (0.68 \times a)
\end{align*}
となり，$a=0.80$，$b=0.05$，$c=-0.07$ を得ます（以下のコード参照）。

```{r}
vec_r <- c(0.78, 0.53, 0.50)
mat_c <- rbind(
    c(1.00, 0.66, 0.68),
    c(0.66, 1.00, 0.60),
    c(0.68, 0.60, 1.00)
)
# 逆行列を求める
solve(mat_c, vec_r) |> round(2)
```

つまり，「親の収入（$x_1$）」と「達成度（$y$）」の相関は，$x_1$の直接的な影響$a$と，「学業成績（$x_2$）」を経由して与える影響$(d\times b)$と，「向上心（$x_3$）」から伝わる影響$(e\times c)$を合わせたものとして表現された（相関をモデル化した）ということがわかります。実際，
\begin{align*}
x_1 と y \ の相関 =&
0.80 + (0.66 \times 0.05) +
(0.68 \times (-0.07))\\
=&0.80 + 0.033 - 0.0476=0.7854
\end{align*}
となり，丸め誤差はありますが相関係数が復元されます。

同様に，$x_2$ と $y$ の相関は$0.536$，$x_3$と$y$は$0.504$です。

## 決定係数
先に，「パス図において，２つの変数または*１つの変数*に注目し，その変数に至るパスを辿って，各パスの係数を掛け，可能なパスすべての結果を足し合わせる」ことをトレーシングルールとして示しました。

従属変数 $y$ について，$y$ 自身に至るパスを考えてみましょう。自分との共分散（相関）ですから，すなわち $y$ の分散（標準偏差）です。

順行するまでは逆行できるので，$x_1$ に行って $y$ に戻ってくる経路 $a \times a$ がまず考えられます。$b^2$，$c^2$ も同様です。

また，$y$ から $x_1$ に行って $x_2$ に渡って $y$ に戻ってくる，すなわち $(a\times d \times b)$ のパスがあります。これは $b\rightarrow d \rightarrow a$ の順でもOKです。したがって $2adb$ となります。

誤差項のパスもあります。誤差に逆行してぐるっと回って $y$ に戻る $(1 \times g \times 1)$ の経路です。

以上から
\begin{align*}
y\ の分散=
a^2 + b^2 + c^2 + 2(adb) + 2(aec) + 2(bfc) + g
\end{align*}
です。標準化しているので
\begin{align*}
1.00=
(0.80)^2 &+ (0.05)^2 + (-0.07)^2 + \\
&2(0.80\cdot 0.66\cdot 0.05) + 2\cdot (0.80\cdot 0.68 \cdot (-0.07)) + \\
&2\cdot (0.05 \cdot 0.60 \cdot (-0.07)) + g
\end{align*}
が得られ，ここから
\begin{align*}
1.00=0.62+g\\
g=0.38
\end{align*}
と求めることができます。標準化された状況での（予測）誤差の分散ですから，逆に従属変数 $y$ の分散説明率，すなわち決定係数 $R^2$ は
$$
R^2=0.62
$$
であることがわかります。

## 間接効果
重回帰モデルしか分析手法がない場合とくらべて，
パスモデルでは，例えば３つの変数の関係を以下のように表すことができます。

![](/images/ch05_path_seq.png){width=75%}

![](/images/ch05_path_two.png){width=75%}

![](/images/ch05_path_indirect.png){width=75%}

このように柔軟にモデル構成ができると，重回帰モデルにはなかったタイプの変数の影響を考えることができます。**間接効果**
（indirect effect）と呼ばれる波及効果です。
間接効果は，ひとつの影響が，他の変数を経由して複合的に及びます。
例えば，一番上の図の $(a \times b)$ や一番下の $(a \times b)$ が間接効果にあたります。

## **R** による分析
### 相関係数行列の入力
パスモデル（SEM）の枠組みでの分析には，**R**のパッケージ*lavaan*（*la* tent *va* riable *an* lysis）を使用します。

まず，相関係数行列を読み込みます。*lavaan*の関数<code>lav_matrix_lower2full()</code>を利用すれば，
下三角行列の状態で入力しても問題ありません。
データフレームでなくても，行名と列名を付すことで分析データとして使用できます。
```{r}
require(lavaan)
mat_cor <- lav_matrix_lower2full(
  c(1.00,
    0.66, 1.00,
    0.68, 0.60, 1.00,
    0.78, 0.53, 0.50, 1.00))
vec_vnames <- c("x1", "x2", "x3", "y")
rownames(mat_cor) <- vec_vnames
colnames(mat_cor) <- vec_vnames
print(mat_cor)
```

上のように，分析対象の相関係数行列を用意できました。

### モデル式
続いてモデル式を記述します。

```{r}
mdl_path_multireg <- '
  y ~ a*x1 + b*x2 + c*x3 # 重回帰モデル
  # 以下4行は記述しなくても本来は支障なし
  # 誤差分散と独立変数間の共分散にラベル付け
  # いずれもlavaanは自動的に設定するため
  # 分析者が明示的に記述する必要はない
  y ~~ g*y
  x1 ~~ d*x2
  x1 ~~ e*x3
  x2 ~~ f*x3
'
```

1行目がモデル式のオブジェクト名で，代入の<code><-</code>の後に引用符<code>' '</code>が続いています。
つまり，文字列としてモデルを記述しているということです。
二重引用符<code>" "</code>でも同じです。

切片を含む重回帰モデルの式
$$y = i + ax_1+bx_2+cx_3+誤差$$
に対して，**R**での変数名がそれぞれ<code>y, x1, x2, x3</code>に対応しているとき，式は<code>y ~ 1 + x1 + x2 + x3</code>と表します。関数<code>lm()</code>の表記と共通していますが，$x$ **によって** $y$ が予測，説明されるとき，<code>y ~ x</code>のように記述します。

係数 $a$，$b$，$c$ を書く必要はありません。また，誤差項の記述も不要です。

<code> ~ 1</code>は定数，平均，切片を表す記法です。ただし，ここでは標準化したデータを考え，切片項の $i$ は扱わない
 $y = ax_1+bx_2+cx_3+誤差$ 
を考えているので，上記2行目に<code> ~ 1</code>の記述はありません。

コメントでも示しましたが，記号<code>\*</code>はパラメータにラベルを付けるための印です。まず，誤差分散は
（*lavaan*が自動的に設定してくれますが）<code>y~~y</code>と表します。
<code> ~~ </code>が分散・共分散の表記です。変数 $y$ と $y$，つまり自分自身との共分散なので分散，しかもここでは誤差変数の分散を表すことになります。

その上で，<code>g*</code>を間に挟み，この誤差分散に<code>g</code>というラベルを付けています。以下，<code>x1~~d\*x2</code>なども同様です。パス図で示したアルファベットと対応するようにラベルを付しています。

<code>lavaan()</code>では，モデルで直接推定される係数以外に，モデル内のパラメータを使って新しいパラメータを定義することができます。このモデルにはありませんが，間接効果を定義可能です。記号は <code>:=</code> を使います。例えば，親の収入 $x_1$ の多寡が学業上の向上心 $x_2$ を変化させ，その影響が達成度 $y$ に及ぶ，というモデルの場合，各々のパス係数が $a$ と $b$ であった場合，<code>y ~ a\*x1 + b\*x2</code>
のように，パス係数にラベルをつけた上で，
<code>ind_eff := a \* c</code>のように記述します。<code>ind_eff</code>は私がつけたラベルで，他でももちろんかまいません。また，<code>a \* c</code>の<code>\*</code>はラベル付けではなく，係数を掛け合わせて間接効果を表しています。

まとめると，以下の通りです。
![](/images/ch05_tab_syntax.png){width=90%}


### 分析の実行

パッケージ*lavaan*には，その名と同じ，SEMの分析に汎用的に使える関数<code>lavaan()</code>がありますが，ここでは以下のように関数<code>sem()</code>を使って推定を行います。<code>sem()</code>は<code>lavaan()</code>のラッパー関数です。いくつかの引数が，ここでの分析に適切な形であらかじめ設定されています。詳しくは<code>?sem()</code>で確認しましょう。

```{r}
fit_path_multireg <- sem(mdl_path_multireg,
  sample.cov = mat_cor, sample.nobs = 100)
summary(fit_path_multireg, rsquare = TRUE)
```

<code>sem()</code>（<code>lavaan()</code>）は，共分散行列（およびサンプルサイズ指定）か，またはデータフレームを分析対象として受け付けます。今回は引数<code>sample.cov</code>と<code>sample.nobs</code>にそれぞれ4変数の相関係数行列と人数を指定しています。データフレームの場合は，引数<code>data</code>に与えます。

分析結果のオブジェクトを関数<code>summary()</code>に渡すと，何も指定しなければ主に以下が出力されます。

1. 推定が収束したか（最適計算が無事に終了したか）
1. 推定法
1. サンプルサイズ
1. 適合度指標（$\chi^2$統計量とその自由度および$p$値）
1. 非標準化解
1. 標準誤差
1. 推定値と標準誤差の比（Wald統計量）と$p$値

<code>lavaan()</code>の推定結果用の<code>summary()</code>の重要な引数は，

* <code>standardized</code>
* <code>fit.measures</code>
* <code>rsquare</code>
* <code>modindices</code>

です。ここでは<code>rsquare=TRUE</code>とし，従属変数の決定係数（のみ）を確認しましたが，基本的には上記4つすべて<code>TRUE</code>にしておきましょう。

### 実習

1. 4変数の相関行列を使って以下のパス図の分析をしなさい。
![](/images/ch05_path_achieve.png){width=85%}